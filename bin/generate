#!/usr/bin/env ruby

path = File.expand_path("../../lib", __FILE__)
$LOAD_PATH.unshift(path)

require 'minecraft'
require 'optparse'

options = {}
parser = OptionParser.new do |opts|
  opts.banner = "Usage: #{$0} [options]"
  opts.separator ""

  opts.on("-c", "--client USERNAME", String,
          "The `username` to use when generating a client app") do |username|
    options[:username] = username
  end

  opts.on("-s", "--server VERSION", String,
          "The Minecraft server version") do |version|
    options[:version] = version
  end

  opts.on("-u", "--usercache",
          "Generate a new 'usercache.json' file") do
    options[:usercache] = true
  end

  opts.separator ""
  opts.on("-C", "--cleanup",
          "Remove generated files and package directory") do
    Minecraft.cleanup!
    exit
  end

  opts.separator ""
  opts.on("-h", "--help", "Prints this help") do
    puts opts
    exit
  end
end

args = ARGV.dup
parser.parse!(args)

if username = options[:username]
  Minecraft::ClientGenerator.new(username: username).generate

elsif options[:version]
  options[:servername] = args.first unless args.empty?
  Minecraft::ServerGenerator.new(options).generate

elsif options[:usercache]
  File.open("usercache.json", "w") do |fd|
    fd.write(JSON.generate(Minecraft.players.usercache))
  end

else
  puts parser.help
  exit 1
end

# Saving the players file is idempotent
Minecraft.players.save_players

